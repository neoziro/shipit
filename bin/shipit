#!/usr/bin/env node

var chalk = require('chalk');
var interpret = require('interpret');
var v8flags = require('v8flags');
var Liftoff = require('liftoff');
var argv = require('minimist')(process.argv.slice(2));
var prompt = require('prompt');
var Shipit = require('../lib/shipit');
var pkg = require('../package.json');

// Initialize cli.
var cli = new Liftoff({
  name: 'shipit',
  extensions: interpret.jsVariants,
  v8flags: v8flags
});

// Launch cli.
cli.launch({
  cwd: argv.cwd,
  configPath: argv.shipitfile,
  require: argv.require,
  completion: argv.completion
}, invoke);

/**
 * Invoke CLI.
 *
 * @param {object} env CLI environment
 */

function invoke(env) {
  if (argv.version) {
    console.info('v%s', pkg.version);
    exit(0);
  }

  if (!env.configPath) {
    console.error(chalk.red('shipitfile not found'));
    exit(1);
  }

  if (argv._.length === 0) {
    console.error(chalk.red('environment not found'));
    exit(1);
  }

  // Run the 'default' task if no task is specified
  var tasks = argv._.slice(1);
  if (tasks.length === 0) {
    tasks.push('default');
  }

  try {
    initShipit(argv._[0], env.configPath, tasks);
  } catch (e) {
    console.error(chalk.red(e.message));
    exit(1);
  }
}

/**
 * Initialize shipit.
 *
 * @param {string} env Shipit environement
 * @param {string} shipfile Shipitfile path
 * @param {string[]} tasks Tasks
 */

function initShipit(env, shipfile, tasks) {
  // Create.
  var shipit = new Shipit({environment: env});

  // Load shipfile.
  require(shipfile)(shipit);

  // Initialize shipit.
  shipit.initialize();


  if (Array.isArray(shipit.config.disallowTasks)) {
    if (!tasks.every( (currentValue) => {
        if (shipit.config.disallowTasks.indexOf(currentValue) > -1) {
          console.log('Task \'' + currentValue + '\' is a disallowed task for \'' + shipit.environment + '\', aborting task(s)!')
          return false;
        }
        return true;
      }) ) {
      
      exit(1);
    }
  }
  if (Array.isArray(shipit.config.warnTasks)) {
    if (!tasks.every( (currentValue) => {
        if (shipit.config.warnTasks.indexOf(currentValue) > -1) {
          console.log('Task \'' + currentValue + '\' needs verification to run in \'' + shipit.environment + '\'.')
          return false;
        }
        return true;
      }) ) {
      prompt.start();
      prompt.get([{
        name: 'confirmEnv',
        description: '\nTo run please type \'' + shipit.environment + '\'',
        type: 'string',
        required: true
      }], function(err, results) {
        if (results.confirmEnv === shipit.environment) {
          prompt.stop();
          shipit.start(tasks);
        } else {
          prompt.stop();
          console.log('Failed to confirm, aborting task(s)!')
          exit(1);
        }
      });
    } else {
      // If there are warn tasks, but our tasks aren't one of them - run tasks.
      shipit.start(tasks);
    }
  } else {
    // If there are no warn tasks and tasks are not disallowed - run tasks.
    shipit.start(tasks);
  }

  //Regardless if there are warn or disallow tasks, we need to set handlers for if tasks run.
  shipit.on('task_err', function () {
    exit(1);
  });

  shipit.on('task_not_found', function () {
    exit(1);
  });
}

/**
 * Properly exit.
 * Even on Windows.
 *
 * @param {number} code Exit code
 */

function exit(code) {
  if (process.platform === 'win32' && process.stdout.bufferSize) {
    process.stdout.once('drain', function() {
      process.exit(code);
    });
    return;
  }
  process.exit(code);
}
